<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>C++ → WASM — Compile & Run (Clang + LLD)</title>
  <style>
    :root{ --bg:#0b0e14; --panel:#111827; --panel2:#0f172a; --accent:#4f8cff; --muted:#9aa4b2; --txt:#e6edf3; --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --br:#1f2937; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--txt); font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif; display:flex; flex-direction:column}
    header{background:linear-gradient(0deg,var(--panel),var(--panel2)); border-bottom:1px solid var(--br); padding:12px 14px; display:flex; gap:10px; align-items:center}
    h1{margin:0; font-size:16px; letter-spacing:.2px}
    .sp{flex:1}
    .btn{background:var(--accent); color:#fff; border:0; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    label{font-size:12px; color:var(--muted)}
    main{flex:1; display:grid; grid-template-columns:1.2fr .8fr; gap:10px; padding:10px; min-height:0}
    .card{background:var(--panel); border:1px solid var(--br); border-radius:12px; overflow:hidden; display:flex; flex-direction:column; min-height:0}
    .card h2{margin:0; padding:10px 12px; border-bottom:1px solid var(--br); color:var(--muted); font-size:12px; letter-spacing:.3px}
    #editor{height:100%; width:100%}
    .section{padding:10px; display:flex; flex-direction:column; gap:10px; min-height:0}
    textarea,pre{width:100%; background:#0b1220; color:var(--txt); border:1px solid #223048; border-radius:8px; padding:10px; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:13px}
    pre{margin:0; white-space:pre-wrap; overflow:auto; flex:1}
    .row{display:flex; gap:10px; align-items:center}
    .grow{flex:1}
    .badge{display:inline-block; padding:2px 6px; border-radius:6px; font-size:11px; background:#0b1220; border:1px solid #223048; color:var(--muted)}
    .log.ok{color:var(--ok)} .log.warn{color:var(--warn)} .log.err{color:var(--err)}
    footer{padding:8px 12px; color:var(--muted); font-size:12px; border-top:1px solid var(--br); background:var(--panel2)}
    a{color:#8ab4ff}
  </style>
</head>
<body>
  <header>
    <h1>C++ → WebAssembly: Compile & Run</h1>
    <div class="sp"></div>
    <label><input id="optO3" type="checkbox" checked /> -O3</label>
    <label><input id="showTiming" type="checkbox" /> Show timing</label>
    <button id="runBtn" class="btn">Compile & Run ▶</button>
  </header>

  <main>
    <div class="card">
      <h2>main.cpp</h2>
      <div id="editor"></div>
    </div>

    <div class="card">
      <h2>Console</h2>
      <div class="section">
        <div class="row">
          <textarea id="stdin" class="grow" rows="3" placeholder="STDIN (optional)"></textarea>
        </div>
        <pre id="console"></pre>
        <div class="row">
          <span class="badge" id="artifactInfo">artifact: (none)</span>
          <span class="badge" id="toolchainInfo">toolchain: loading…</span>
        </div>
      </div>
    </div>
  </main>

  <footer>
    Hosted on GitHub Pages is fine.
  </footer>

  <!-- Ace Editor -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.9/ace.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Main logic -->
  <script>
    // --- editor with your simple base program ---
    const editor = ace.edit("editor", {
      mode: "ace/mode/c_cpp",
      theme: "ace/theme/one_dark",
      value:
`#include <iostream>

int main() {
  std::cout << "Hello, World!" << std::endl;
  return 0;
}
`,
      fontSize: 14, useWorker:false, tabSize:2, showPrintMargin:false, wrap:true
    });
    editor.session.setMode("ace/mode/c_cpp");

    const runBtn = document.getElementById('runBtn');
    const consoleEl = document.getElementById('console');
    const stdinEl = document.getElementById('stdin');
    const artifactInfo = document.getElementById('artifactInfo');
    const toolchainInfo = document.getElementById('toolchainInfo');
    const showTiming = document.getElementById('showTiming');
    const optO3 = document.getElementById('optO3');

    function clearConsole(){ consoleEl.textContent=''; }
    function log(msg, cls=''){ const d=document.createElement('div'); d.className='log '+cls; d.textContent=msg; consoleEl.appendChild(d); consoleEl.scrollTop=consoleEl.scrollHeight; }
    function clog(...a){ console.log('[CPP/WASM]', ...a); }

    // Use prebuilt worker from jsDelivr (CORS-friendly) and keep all assets on the same CDN.
    const BASE = 'https://cdn.jsdelivr.net/gh/binji/wasm-clang';
    let workerReady = false;

    runBtn.disabled = true;
    log('Loading toolchain…');

    let worker, watchdog;
    try {
      worker = new Worker('./worker.js'); // cross-origin okay on jsDelivr
      watchdog = setTimeout(() => {
        if (!workerReady) {
          log('Worker timed out. If this persists, the CDN might be blocked.', 'warn');
        }
      }, 12000); // generous first-load window
    } catch (e) {
      clog('Worker construction failed:', e);
      log('Failed to start toolchain worker.', 'err');
    }

    if (worker) {
      worker.onmessage = (e) => {
        const {type} = e.data || {};
        if (type === 'log') {
          if (showTiming.checked) log(e.data.msg);
        } else if (type === 'ready') {
          clearTimeout(watchdog);
          workerReady = true;
          toolchainInfo.textContent = 'toolchain: ' + e.data.info;
          runBtn.disabled = false;
          if (showTiming.checked) log('Toolchain ready ✔','ok');
        } else if (type === 'artifact') {
          artifactInfo.textContent = `artifact: ${e.data.name} (${e.data.size} bytes)`;
        } else if (type === 'output') {
          if (e.data.stdout) log(e.data.stdout.replace(/\x1b\[[0-9;]*m/g,'')); // strip ANSI
          if (e.data.stderr) log(e.data.stderr.replace(/\x1b\[[0-9;]*m/g,''), 'warn');
        } else if (type === 'error') {
          log(e.data.message, 'err');
          runBtn.disabled = false;
        } else if (type === 'done') {
          if (showTiming.checked) log('total: ' + e.data.time, 'ok');
          runBtn.disabled = false;
        }
      };

      // Kick off worker load from the same CDN base
      try {
        worker.postMessage({ type: 'load', base: BASE, showTiming: false });
      } catch (e) {
        clog('postMessage(load) failed:', e);
        log('Could not initialize toolchain.', 'err');
      }
    }

    // Compile & run
    runBtn.addEventListener('click', () => {
      clearConsole();
      log('Compiling…');
      runBtn.disabled = true;
      if (!workerReady) { log('Toolchain not ready.', 'err'); runBtn.disabled = false; return; }
      worker.postMessage({
        type: 'run',
        src: editor.getValue(),
        opts: { filename: 'main.cpp', optimize: !!optO3.checked, stdin: stdinEl.value }
      });
    });
  </script>
</body>
</html>
