<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>C++ → WASM — Compile & Run (Direct Load)</title>
  <style>
    :root{ --bg:#0b0e14; --panel:#111827; --panel2:#0f172a; --accent:#4f8cff; --muted:#9aa4b2; --txt:#e6edf3; --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --br:#1f2937; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--txt); font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif; display:flex; flex-direction:column}
    header{background:linear-gradient(0deg,var(--panel),var(--panel2)); border-bottom:1px solid var(--br); padding:12px 14px; display:flex; gap:10px; align-items:center}
    h1{margin:0; font-size:16px; letter-spacing:.2px}
    .sp{flex:1}
    .btn{background:var(--accent); color:#fff; border:0; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    label{font-size:12px; color:var(--muted)}
    main{flex:1; display:grid; grid-template-columns:1.2fr .8fr; gap:10px; padding:10px; min-height:0}
    .card{background:var(--panel); border:1px solid var(--br); border-radius:12px; overflow:hidden; display:flex; flex-direction:column; min-height:0}
    .card h2{margin:0; padding:10px 12px; border-bottom:1px solid var(--br); color:var(--muted); font-size:12px; letter-spacing:.3px}
    #editor{height:100%; width:100%}
    .section{padding:10px; display:flex; flex-direction:column; gap:10px; min-height:0}
    textarea,pre{width:100%; background:#0b1220; color:var(--txt); border:1px solid #223048; border-radius:8px; padding:10px; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:13px}
    pre{margin:0; white-space:pre-wrap; overflow:auto; flex:1}
    .row{display:flex; gap:10px; align-items:center}
    .grow{flex:1}
    .badge{display:inline-block; padding:2px 6px; border-radius:6px; font-size:11px; background:#0b1220; border:1px solid #223048; color:var(--muted)}
    .log.ok{color:var(--ok)} .log.warn{color:var(--warn)} .log.err{color:var(--err)}
    footer{padding:8px 12px; color:var(--muted); font-size:12px; border-top:1px solid var(--br); background:var(--panel2)}
    a{color:#8ab4ff}
  </style>
</head>
<body>
  <header>
    <h1>C++ → WebAssembly: Compile & Run</h1>
    <div class="sp"></div>
    <label><input id="optO3" type="checkbox" checked /> -O3</label>
    <button id="runBtn" class="btn" disabled>Compile & Run ▶</button>
  </header>

  <main>
    <div class="card">
      <h2>main.cpp</h2>
      <div id="editor"></div>
    </div>

    <div class="card">
      <h2>Console</h2>
      <div class="section">
        <div class="row">
          <textarea id="stdin" class="grow" rows="3" placeholder="STDIN (optional)"></textarea>
        </div>
        <pre id="console"></pre>
        <div class="row">
          <span class="badge" id="artifactInfo">artifact: (none)</span>
          <span class="badge" id="toolchainInfo">toolchain: loading…</span>
        </div>
      </div>
    </div>
  </main>

  <footer>
    Make sure <code>shared.js</code>, <code>shared_web.js</code>, <code>clang.js/.wasm</code>, <code>lld.js/.wasm</code>, <code>memfs.js/.wasm</code>, and <code>sysroot.tar</code> are in the same folder as this file.
  </footer>

  <!-- Ace Editor -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.9/ace.js" crossorigin="anonymous"></script>
  <!-- wasm-clang helpers -->
  <script src="./shared.js"></script>
  <script src="./shared_web.js"></script>

  <script>
    const editor = ace.edit("editor", {
      mode: "ace/mode/c_cpp",
      theme: "ace/theme/one_dark",
      value:
`#include <iostream>

int main() {
  std::cout << "Hello, World!" << std::endl;
  return 0;
}
`,
      fontSize: 14, useWorker:false, tabSize:2, showPrintMargin:false, wrap:true
    });
    editor.session.setMode("ace/mode/c_cpp");

    const runBtn = document.getElementById('runBtn');
    const consoleEl = document.getElementById('console');
    const stdinEl = document.getElementById('stdin');
    const artifactInfo = document.getElementById('artifactInfo');
    const toolchainInfo = document.getElementById('toolchainInfo');
    const optO3 = document.getElementById('optO3');

    function clearConsole(){ consoleEl.textContent=''; }
    function log(msg, cls=''){ const d=document.createElement('div'); d.className='log '+cls; d.textContent=msg; consoleEl.appendChild(d); consoleEl.scrollTop=consoleEl.scrollHeight; }

    (async () => {
      try {
        const base = './';
        await loadClang(base);
        await loadLLD(base);
        await untarSysroot(base + 'sysroot.tar');
        toolchainInfo.textContent = 'toolchain: ready';
        runBtn.disabled = false;
        log('Toolchain ready ✔','ok');
      } catch (e) {
        toolchainInfo.textContent = 'toolchain: failed';
        log('Error loading toolchain: ' + (e.message||e), 'err');
      }
    })();

    runBtn.addEventListener('click', async () => {
      clearConsole();
      log('Compiling…');
      runBtn.disabled = true;
      try {
        const src = editor.getValue();
        const obj = await clangCompile(src, { filename: 'main.cpp', optimize: !!optO3.checked });
        const wasm = await lldLink([obj], { output: 'a.wasm' });
        const res = await runWasi(wasm.bytes, { stdin: stdinEl.value });
        artifactInfo.textContent = `artifact: a.wasm (${wasm.bytes.byteLength} bytes)`;
        if (res.stdout) log(res.stdout);
        if (res.stderr) log(res.stderr, 'warn');
      } catch (e) {
        log('Error: ' + (e.message||e), 'err');
      } finally {
        runBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
